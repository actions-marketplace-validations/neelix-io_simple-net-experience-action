name: 'Action handling'
description: 'Action for generating Neelix experiences from merged PR reviews.'
inputs:
  # TODO: remove before project becomes public
  temp-pat:
    description: 'PAT needed temporarily while project is private'
    required: true
  api-token:
    description: 'Neelix API token (should be stored as secret)'
    required: true
  consortium-id:
    description: 'ID of consortium that created experiences will belong to'
    required: true
  keyword-1-value:
    description: 'Keyword to use in deriving weight for Neelix experiences'
  keyword-1-weight:
    description: 'Weight to assign to each appearance of keyword-1'
  keyword-2-value:
    description: 'Keyword to use in deriving weight for Neelix experiences'
  keyword-2-weight:
    description: 'Weight to assign to each appearance of keyword-2'
runs:
  using: composite
  steps:
    - name: Consolidate keywords
      id: consolidate-keywords
      run: |
        # concatenate keywords and weights into string like v1,w1:v2,w2:
        if [[ -n "${{ inputs.keyword-1-value }}" && -n "${{ inputs.keyword-1-weight }}" ]]
        then
          KEYWORDS="$KEYWORDS:${{ inputs.keyword-1-value }},${{ inputs.keyword-1-weight }}"
        fi
        if [[ -n "${{ inputs.keyword-2-value }}" && -n "${{ inputs.keyword-2-weight }}" ]]
        then
          KEYWORDS="$KEYWORDS:${{ inputs.keyword-2-value }},${{ inputs.keyword-2-weight }}"
        fi
        # remove leading colon
        if [[ -n "$KEYWORDS" ]]
        then
          KEYWORDS=${KEYWORDS:1}
        fi
        echo "$KEYWORDS"
        echo "keywords=$KEYWORDS" >> "$GITHUB_ENV"
      shell: bash
    - name: Get PR review data
      id: get-reviews
      run: |
        REPO=${{ github.repository }}
        echo "repo: $REPO"
        PR_NUMBER=${{ github.event.number }}
        echo "pr number: $PR_NUMBER"
        echo "REVIEWS<<EOF" >> "$GITHUB_ENV"
        curl -sL \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ github.token }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews >> "$GITHUB_ENV"
        echo "EOF" >> "$GITHUB_ENV"
        echo "$REVIEWS"
        echo "review_data='$REVIEWS'" >> "$GITHUB_ENV"
      shell: bash
    - uses: actions/checkout@v3
      with:
        repository: neelix-io/action-handling
        ref: project-initialization
        token: ${{ inputs.temp-pat }}  # TODO: remove before project becomes public
    - name: Process review data
      id: process-reviews
      uses: ./.github/actions/process-reviews
      with:
        review-data: ${{ env.review_data }}
        keywords: ${{ env.keywords }}
    - name: Send request
      id: send-request
      uses: neelix-io/generic-action@project-initialization
      with:
        api-token: ${{ inputs.api-token }}
        consortium-id: ${{ inputs.consortium-id }}
        commentary: ${{ steps.process-reviews.outputs.commentary }}
